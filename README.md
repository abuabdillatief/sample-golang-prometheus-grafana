# Go Application with Prometheus and Grafana Dashboard

This repository demonstrates a sample Go application instrumented with Prometheus metrics and visualized with Grafana dashboards. The infrastructure is managed with Terraform, making it easy to replicate and deploy.

## Project Structure

```
.
├── docker-compose.yml       # Docker setup for Prometheus and Grafana
├── go.mod                   # Go module file
├── go.sum                   # Go module dependencies
├── main.go                  # Main application entry point
├── makefile                 # Make commands for common operations
├── README.md                # This file
├── handler/
│   └── handler.go           # HTTP handlers for the application
├── loadtest/
│   ├── test.go              # Load testing tool
│   └── README.md            # Documentation for the load testing tool
├── middleware/
│   └── prom.go              # Prometheus middleware for HTTP metrics
├── prometheus/
│   └── prometheus.yml       # Prometheus configuration (generated by Terraform)
└── terraform/
    └── main.tf              # Terraform configuration for Prometheus and Grafana
```

## Prerequisites

- Go 1.16 or later
- Docker and Docker Compose
- Terraform v1.0.0 or later

## Setup and Usage

### Step 1: Set Up the Infrastructure

The setup process has been streamlined using a single make command. This command will:
1. Initialize Terraform
2. Generate the Prometheus configuration
3. Start Prometheus and Grafana containers

```bash
make tool_up
```

This command will spin up Prometheus and Grafana containers. Prometheus will be available at http://localhost:9090 and Grafana at http://localhost:3000.

### Step 2: Run the Application

Start the Go application:

```bash
make run
```

The application will be available at http://localhost:8080 with the following test endpoints:

- `/test/fast` - Returns a quick response
- `/test/slow` - Simulates a slow API response (1-3 seconds)
- `/test/random` - Returns random HTTP status codes
- `/test/error` - Always returns an error (500)
- `/test/ok` - Always returns a successful response (200)
- `/metrics` - Prometheus metrics endpoint

### Step 3: Apply Grafana Dashboard Configuration

To create Grafana panels etc:

```bash
make terraform-apply
```

This will apply the Terraform configuration to create dashboards in Grafana. To see the planned changes without applying:

```bash
make terraform-plan
```

### Step 4: Generate Test Traffic

To simulate traffic to your application, run the load test:

```bash
make load_test
```

This will send requests to all endpoints of your application, generating metrics that will be visible in your Grafana dashboards.

## Simulation Guide

Follow these steps to fully simulate and test the monitoring setup:

1. **Start all services**:
   ```bash
   make tool_up
   ```
   This will generate the Prometheus configuration with Terraform and then start the Docker containers.

2. **Run the application**:
   ```bash
   make run
   ```
   Keep this terminal open; the application needs to stay running.

3. **Apply the Grafana dashboard configuration**:
   ```bash
   make terraform-apply
   ```
   When prompted, type `yes` to confirm the application.

4. **Generate test traffic**:
   ```bash
   make load_test
   ```
   Let this run for at least a minute to generate sufficient metrics data.

5. **Access the Grafana dashboard**:
   - Open your browser and navigate to: http://localhost:3000
   - Login with default credentials: 
     - Username: `admin`
     - Password: `admin`
   - Navigate to Dashboards → Browse → Application Metrics → API Metrics Dashboard

6. **Explore the metrics**:
   - The dashboard provides various panels showing:
     - Request counts by path
     - Error rates
     - HTTP status distribution
     - Average request duration
     - 95th percentile request duration
     - Request duration heatmap

7. **Test individual endpoints manually**:
   ```bash
   # Fast response
   curl http://localhost:8080/test/fast
   
   # Slow response
   curl http://localhost:8080/test/slow
   
   # Random status code
   curl http://localhost:8080/test/random
   
   # Error response
   curl http://localhost:8080/test/error
   
   # OK response
   curl http://localhost:8080/test/ok
   ```

8. **View real-time metrics in Prometheus**:
   - Open your browser and navigate to: http://localhost:9090
   - Try querying metrics like:
     - `rate(requests_total[5m])`
     - `histogram_quantile(0.95, sum(rate(request_duration_seconds_bucket[5m])) by (le, path))`

## How It Works

1. **Terraform Management**:
   - Terraform generates the Prometheus configuration file (`prometheus.yml`)
   - Terraform creates Grafana dashboards after the infrastructure is running
   - All configuration is managed as code for reproducibility

2. **Metrics Collection**:
   - The Go application exposes metrics at the `/metrics` endpoint
   - Prometheus scrapes these metrics at regular intervals
   - The middleware logs request count, duration, and errors

3. **Visualization**:
   - Grafana connects to Prometheus as a data source
   - Multiple panels display different aspects of the application metrics
   - The dashboard automatically updates every 10 seconds

## Customization

- Modify `handler/handler.go` to add additional endpoints
- Adjust metrics in `middleware/prom.go`
- Update dashboard panels in `terraform/main.tf`
- Configure Prometheus scraping behavior in the Terraform configuration

## Shutting Down

To stop all services:

```bash
docker compose down
```

## License

[MIT](LICENSE)